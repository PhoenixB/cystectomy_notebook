---
title: "R Notebook for the cystectomy study"
author: "Pascal Jerney"
date: "3rd May 2020"
output:
  bookdown::gitbook:
    config:
      toc:
        collapse: subsection
        scroll_highlight: yes
        before: null
        after: null
      toolbar:
        position: fixed
      edit : null
      download: ["notebook_cystectomy.pdf", "notebook_cystectomy.epub"]
      search: yes
      fontsettings:
        theme: white
        family: sans
        size: 2
      sharing:
        facebook: yes
        github: no
        twitter: yes
        linkedin: no
        weibo: no
        instapaper: no
        vk: no
        all: ['facebook', 'twitter', 'linkedin', 'weibo', 'instapaper']
      info: yes
  html_notebook: default
  pdf_document: default
---

```{r setup, echo=FALSE}
# Load packages ----
if (!require("pacman")) {
  install.packages("pacman")
}
pacman::p_load(
  "tidyverse",
  "rprojroot",
  "fs",
  "tableone",
  "modelr",
  "tidybayes",
  "gridExtra",
  "sjPlot",
  "htmltools",
  "brms",
  "bayestestR"
)

# Set working directory ----
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "png",
  dpi = 150,
  fig.asp = 0.8,
  fig.width = 10,
  out.width = "100%",
  fig.align = "center"
)

```

```{r load_data, echo=FALSE,cache=FALSE}
# Load data from 0_get_and_tidy_data ----

tibble.oak_bleeding_tidy <-
  read_rds(path = path_wd(
    'empirical',
    '2_pipeline',
    '0_get_and_tidy_data',
    'out',
    'oak_bleeding_tidy',
    ext = 'rds'
  ))

# Filter patients with surgery before 2000 ----
tibble.oak_bleeding_tidy <-
  tibble.oak_bleeding_tidy %>%
  filter(op_year >= 2000)

# Load models from 1_generate_models ----
model.intraoptransfusion_bloodlosspercent_preophb_opyear <-
  read_rds(path = path_wd(
    'empirical',
    '2_pipeline',
    '1_generate_models',
    'out',
    'intraoptransfusion_bloodlosspercent_preophb_opyear',
    ext = 'rds'
  ))

model.bloodlossratio_oak_tcaggr_zage_zbmi_cci_gender_ptumor_pnodes_opyear <-
  read_rds(path = path_wd(
    'empirical',
    '2_pipeline',
    '1_generate_models',
    'out',
    'bloodlossratio_oak_tcaggr_zage_zbmi_cci_gender_ptumor_pnodes_opyear',
    ext = 'rds'
  ))


```

# Index

Welcome to the notebook!

# Prerequisites

## Formulas

  - Indexed blood volume^[Lemmens, H. J. M., Bernstein, D. P., & Brodsky, J. B. (2006). Estimating blood volume in obese and morbidly obese patients. Obesity Surgery, 16(6), 773â€“776. https://doi.org/10.1381/096089206777346673]: $BV_i = \frac{70}{\sqrt{\frac{BMI}{22}}}$^[$BV_i$ = Indexed blood volume, $BMI$ = Body mass index]
  - Estimated blood volume: $BV_e = BV_i * Weight$^[$BV_e$ = Estimated blood volume]
  - Blood loss ratio: $BL_r = \frac{BV_e}{BL_a}$^[$BL_r$ = Blood loss ratio, $BL_a$ = Absolute blood loss]

# Results

## Data plots

```{r data_plots,echo=FALSE}
qqplot_bloodlossratio <-
  tibble.oak_bleeding_tidy %>%
  drop_na(blood_loss_ratio) %>%
  ggplot(aes(sample = blood_loss_ratio)) +
  geom_qq() +
  geom_qq_line() +
  labs(title = "Q-Q-Plot for blood loss ratio", subtitle = "Normal scale", x = "Theoretical quantiles", y = "Sample quantiles") +
  theme_light()

qqplot_logbloodlossratio <-
  tibble.oak_bleeding_tidy %>%
  drop_na(blood_loss_ratio) %>%
  ggplot(aes(sample = log(blood_loss_ratio))) +
  geom_qq() +
  geom_qq_line() +
  labs(title = "Q-Q-Plot for blood loss ratio", subtitle = "Natural logarithm scale", x = "Theoretical quantiles", y = "Sample quantiles") +
  theme_light()

grid.arrange(qqplot_bloodlossratio, qqplot_logbloodlossratio, ncol = 2)

tibble.oak_bleeding_tidy %>%
drop_na(blood_loss_ratio) %>%
ggplot(aes(x = blood_loss_ratio)) +
geom_histogram(binwidth = 0.05) +
labs(title = "Histogram of blood loss ratio", x = "Blood loss ratio", y = "Count") +
theme_light()

tibble.oak_bleeding_tidy %>%
drop_na(intraop_transfusion) %>%
ggplot(aes(x = intraop_transfusion)) +
geom_bar() +
labs(title = "Bar chart of intraoperative transfusion", x = "Intraoperative transfusion", y = "Count") +
theme_light()
```

## Model outputs

### Model 1

Model with intraoperative transfusion as response, blood loss percentage and preoperative hemoglobin as population-level effects and operation year as group-level effect.

#### Coefficients table

```{r model1_table,echo=FALSE,results="asis"}
tab_model(
  model.intraoptransfusion_bloodlosspercent_preophb_opyear,
  rm.terms = c("Intercept"),
  pred.labels = c(
    blood_loss_percent = "Percent blood loss",
    preop_hb = "Preoperative hemoglobin"
  ),
  dv.labels = c("Intraoperative transfusion"),
  show.ci = 0.999,
  use.viewer = FALSE
) %>%
.$knitr %>%
cat(.)
```

#### Posterior predictive check plot

```{r model1_ppcheck,echo=FALSE}
pp_check(model.intraoptransfusion_bloodlosspercent_preophb_opyear, nsamples = 10)
```

#### Conditional probability plot

```{r model1_conditional_plot,echo=FALSE}
tibble.oak_bleeding_tidy %>%
data_grid(blood_loss_percent = seq_range(blood_loss_percent, by = 1, pretty = TRUE), preop_hb = seq_range(preop_hb, by = 20, pretty = TRUE)) %>%
add_linpred_draws(model.intraoptransfusion_bloodlosspercent_preophb_opyear, re_formula = NA) %>%
median_hdci(.width = c(0.95, 0.999)) %>%
ggplot(aes(x = blood_loss_percent, y = .value)) +
facet_wrap(vars(preop_hb)) +
geom_lineribbon() +
labs(title = str_wrap("Probability for transfusion depending on preoperative hemoglobin and blood loss percentage", 100), subtitle = "Preoperative Hb", x = "Blood loss ratio", y = "Probability for transfusion") +
coord_cartesian(xlim = c(0, 100)) +
theme_light()
```

### Model 2

Model with blood loss ratio as response, oral anticoagulation, thrombocyte aggregation inhibitors, age, body mass index, charleston comorbidity index, gender, tumor stadium and nodal stadium as population-level effects and operation year as group-level effect.

#### Coefficients table

```{r model2_table,echo=FALSE,results="asis"}
tab_model(
  model.bloodlossratio_oak_tcaggr_zage_zbmi_cci_gender_ptumor_pnodes_opyear,
  pred.labels = c(
    oakTRUE = "Oral anticoagulation",
    tcaggrTRUE = "Thrombocyte aggregation inhibition",
    z_age = "Age (standardized)",
    z_bmi = "Body mass index (standardized)",
    genderfemale = "Female gender",
    bsp_mocci = "Charleston comorbidity index",
    bsp_mop_tumor = "Tumor stadium",
    bsp_mop_nodes = "Nodal stadium"
  ),
  dv.labels = c("Blood loss ratio"),
  show.ci = 0.95,
  rm.terms = c(
    sprintf("simo_mocci1.%d.", seq(1:9)),
    sprintf("simo_mop_tumor1.%d.", seq(1:4)),
    sprintf("simo_mop_nodes1.%d.", seq(1:3))
  ),
  use.viewer = FALSE
) %>%
.$knitr %>%
cat(.)

p_map(model.bloodlossratio_oak_tcaggr_zage_zbmi_cci_gender_ptumor_pnodes_opyear) %>%
as_tibble() %>%
knitr::kable()
```

#### Posterior predictive check plot

```{r model2_ppcheck,echo=FALSE}
pp_check(model.bloodlossratio_oak_tcaggr_zage_zbmi_cci_gender_ptumor_pnodes_opyear, nsamples = 10)
```

#### Conditional distribution plot

```{r model2_conditional_plot,echo=FALSE}
tibble(
  oak = FALSE,
  tcaggr = FALSE,
  z_age = median(tibble.oak_bleeding_tidy$z_age, na.rm = TRUE),
  z_bmi = seq(from = -1, to = 2, length.out = 10), # c(10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60),
  cci = "0",
  gender = "male",
  p_tumor = "0",
  p_nodes = "0"
) %>%
add_predicted_draws(model.bloodlossratio_oak_tcaggr_zage_zbmi_cci_gender_ptumor_pnodes_opyear, re_formula = NA) %>%
ggplot(aes(x = .prediction, colour = factor(z_bmi))) +
geom_freqpoly(binwidth = 0.05) +
labs(title = str_wrap("Distribution of blood loss ratio depending on standardized body mass index", 100), subtitle = str_wrap("Other variables held at reference level or median", 100), x = "Blood loss ratio", y = "Count", colour = "Body mass index (standardized)") +
coord_cartesian(xlim = c(0, 1)) +
theme_light() +
scale_colour_viridis_d()

```
